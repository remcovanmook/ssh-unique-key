#!/bin/bash
set -e
SCRIPT_DIR=$(dirname "$0")
# shellcheck source=./_ssh-unique-key.inc.sh
source "${SCRIPT_DIR}/_ssh-unique-key.inc.sh"

usage() {
    echo "Usage: ssh-history <command> [args]"
    echo "Commands:"
    echo "  list [-n count]        Show recent operations"
    echo "  keys <host>            Show history for a specific host"
    echo "  templates [name]       Show history for templates"
    echo "  -V, --verbose          Enable verbose output"
    echo "  -h, --help             Show this help message"
    echo "  -v, --version          Show version information"
    exit 0
}

POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -v|--version) show_version ;;
        -V|--verbose) VERBOSE=1; shift ;;
        -*) # Handle command flags like -n here or pass through?
            # ssh-history list -n 20
            # We must be careful not to consume flags meant for subcommands if they overlap
            # But currently only -V -h -v are global.
            # If it's a subcommand flag, we push it to positional args.
            POSITIONAL_ARGS+=("$1"); shift ;;
        *) POSITIONAL_ARGS+=("$1"); shift ;;
    esac
done
set -- "${POSITIONAL_ARGS[@]}"

if [ "$#" -lt 1 ]; then usage; fi
COMMAND="$1"
shift

format_log() {
    column -t -s '|'
}

case "$COMMAND" in
    list)
        COUNT="20"
        if [ "$1" == "-n" ] && [ -n "$2" ]; then
            COUNT="$2"
        fi
        echo "TIMESTAMP | USER | ACTION | TARGET | DETAILS"
        echo "---|---|---|---|---"
        tail -n "$COUNT" "$LOG_FILE" | format_log
        ;;
    
    keys)
        HOST="$1"
        if [ -z "$HOST" ]; then usage; fi
        echo "History for host: $HOST"
        echo "TIMESTAMP | USER | ACTION | TARGET | DETAILS"
        grep "|$HOST|" "$LOG_FILE" | format_log
        ;;
        
    templates)
        TEMPLATE="$1"
        if [ -z "$TEMPLATE" ]; then
            echo "Template Operations:"
            echo "TIMESTAMP | USER | ACTION | TARGET | DETAILS"
            grep "|template-" "$LOG_FILE" | format_log
        else
            echo "History for template: $TEMPLATE"
            echo "TIMESTAMP | USER | ACTION | TARGET | DETAILS"
            grep -E "$TEMPLATE" "$LOG_FILE" | format_log
        fi
        ;;
    *) usage ;;
esac
