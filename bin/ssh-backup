#!/bin/bash
set -e
SCRIPT_DIR=$(dirname "$0")
# shellcheck source=./_ssh-unique-key.inc.sh
source "${SCRIPT_DIR}/_ssh-unique-key.inc.sh"

usage() {
    echo "Usage: ssh-backup [-o output_file.tar.gz]"
    echo "  -V, --verbose   Enable verbose output"
    echo "  -h, --help      Show this help message"
    echo "  -v, --version   Show version information"
    exit 0
}

OUTPUT_FILE="${HOME}/ssh-unique-keys-backup-$(date +%Y%m%d).tar.gz"

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -v|--version) show_version ;;
        -V|--verbose) VERBOSE=1; shift ;;
        -o) OUTPUT_FILE="$2"; shift 2 ;;
        *) usage ;;
    esac
done

if [ ! -d "$BASE_DIR" ]; then
    err "Directory $BASE_DIR does not exist."
fi

echo "Backing up $BASE_DIR to $OUTPUT_FILE..."

tar -czf "$OUTPUT_FILE" \
    -C "$(dirname "$BASE_DIR")" \
    --exclude="conf.d" \
    "$(basename "$BASE_DIR")"

echo "Backup complete: $OUTPUT_FILE"
log_event "backup" "all" "Created backup at $OUTPUT_FILE"
