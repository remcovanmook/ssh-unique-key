#!/bin/bash
set -e
SCRIPT_DIR=$(dirname "$0")
# shellcheck source=./_ssh-unique-key.inc.sh
source "${SCRIPT_DIR}/_ssh-unique-key.inc.sh"
ensure_base_dirs

usage() {
    echo "Usage: ssh-template <command> [name]"
    echo "Commands:"
    echo "  list                  List templates"
    echo "  create <name>         Create new template"
    echo "  generate-keys <name>  Generate standard keys"
    echo "  generate-sk <name>    Generate hardware keys"
    echo "  generate-opk <name>   Generate OpenPubKey (opkssh) identity"
    echo "  edit-config <name>    Edit template config"
    echo "  remove <name>         Remove template"
    echo "  -V, --verbose         Enable verbose output"
    echo "  -h, --help            Show this help message"
    echo "  -v, --version         Show version information"
    exit 0
}

# Parse global flags
POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -v|--version) show_version ;;
        -V|--verbose) VERBOSE=1; shift ;;
        -*) err "Unknown option $1"; usage ;;
        *) POSITIONAL_ARGS+=("$1"); shift ;;
    esac
done
set -- "${POSITIONAL_ARGS[@]}"

if [ "$#" -lt 1 ]; then usage; fi
COMMAND="$1"
TEMPLATE_NAME="${2:-}"
TEMPLATE_PATH="$TEMPLATE_DIR/$TEMPLATE_NAME"

case "$COMMAND" in
    list)
        if [ ! -d "$TEMPLATE_DIR" ]; then exit 0; fi
        echo "Templates:"
        ls -1 "$TEMPLATE_DIR" | while read -r tmpl; do
            TYPE=""
            [ -f "$TEMPLATE_DIR/$tmpl/.type" ] && TYPE="($(cat "$TEMPLATE_DIR/$tmpl/.type"))"
            [ -f "$TEMPLATE_DIR/$tmpl/.issuer" ] && TYPE="$TYPE [$(cat "$TEMPLATE_DIR/$tmpl/.issuer")]"
            echo "  - $tmpl $TYPE"
        done
        ;;
    create)
        if [ -z "$TEMPLATE_NAME" ]; then err "Name required."; fi
        if [ -d "$TEMPLATE_PATH" ]; then err "Template '$TEMPLATE_NAME' exists."; fi
        mkdir -p -m 700 "$TEMPLATE_PATH"
        touch "$TEMPLATE_PATH/config" && chmod 600 "$TEMPLATE_PATH/config"
        echo "Created template: $TEMPLATE_NAME"
        log_event "template-create" "$TEMPLATE_NAME" "Created empty template"
        ;;
    generate-keys)
        if [ ! -d "$TEMPLATE_PATH" ]; then err "Template not found."; fi
        echo "Generating standard keys..."
        ssh-keygen -t ed25519 -f "$TEMPLATE_PATH/id_ed25519" -N "" -C "$TEMPLATE_NAME"
        ssh-keygen -t ecdsa -f "$TEMPLATE_PATH/id_ecdsa" -N "" -C "$TEMPLATE_NAME"
        ssh-keygen -t rsa -b 4096 -f "$TEMPLATE_PATH/id_rsa" -N "" -C "$TEMPLATE_NAME"
        chmod 600 "$TEMPLATE_PATH"/id_* && chmod 644 "$TEMPLATE_PATH"/id_*.pub
        rm -f "$TEMPLATE_PATH/.type" "$TEMPLATE_PATH/.issuer"
        log_event "template-genkeys" "$TEMPLATE_NAME" "Generated standard keys"
        ;;
    generate-sk)
        if [ ! -d "$TEMPLATE_PATH" ]; then err "Template not found."; fi
        echo "Generating hardware-backed keys. Touch token when prompted."
        ssh-keygen -t ed25519-sk -f "$TEMPLATE_PATH/id_ed25519_sk" -N "" -C "$TEMPLATE_NAME-sk"
        chmod 600 "$TEMPLATE_PATH"/id_*sk && chmod 644 "$TEMPLATE_PATH"/id_*sk.pub
        rm -f "$TEMPLATE_PATH/.type" "$TEMPLATE_PATH/.issuer"
        log_event "template-gensk" "$TEMPLATE_NAME" "Generated hardware keys"
        ;;
    generate-opk)
        if [ ! -d "$TEMPLATE_PATH" ]; then err "Template not found."; fi
        if ! command -v opkssh &> /dev/null; then
            err "opkssh command not found. Please install OpenPubKey first."
        fi
        
        read -p "Enter Identity Provider (Issuer) URL or shortcut (e.g. 'google') [Leave empty for default]: " INPUT_ISSUER
        
        # --- Shortcut Expansion ---
        case "$INPUT_ISSUER" in
            google) ISSUER="https://accounts.google.com" ;;
            microsoft) ISSUER="https://login.microsoftonline.com/common/v2.0" ;;
            gitlab) ISSUER="https://gitlab.com" ;;
            *) ISSUER="$INPUT_ISSUER" ;;
        esac
        
        OPK_ARGS=""
        if [ -n "$ISSUER" ]; then
            echo "$ISSUER" > "$TEMPLATE_PATH/.issuer"
            OPK_ARGS="--issuer $ISSUER"
        else
            rm -f "$TEMPLATE_PATH/.issuer"
        fi
        
        echo "Starting opkssh login workflow..."
        opkssh login $OPK_ARGS
        
        echo "--------------------------------------------------------"
        echo "Please verify where opkssh saved your key (e.g. ~/.ssh/id_ecdsa)"
        read -p "Enter path to generated private key: " KEY_PATH
        
        if [ ! -f "$KEY_PATH" ]; then
            err "Key not found at $KEY_PATH"
        fi
        
        echo "Importing keys to template..."
        cp "$KEY_PATH" "$TEMPLATE_PATH/identity"
        if [ -f "${KEY_PATH}.pub" ]; then cp "${KEY_PATH}.pub" "$TEMPLATE_PATH/identity.pub"; fi
        
        CERT_PATH="${KEY_PATH}-cert.pub"
        if [ ! -f "$CERT_PATH" ]; then
            echo "Certificate not found at default location ($CERT_PATH)."
            read -p "Enter path to signed certificate (or leave empty if none): " INPUT_CERT
            CERT_PATH="$INPUT_CERT"
        fi
        
        if [ -n "$CERT_PATH" ] && [ -f "$CERT_PATH" ]; then
            cp "$CERT_PATH" "$TEMPLATE_PATH/identity-cert.pub"
            echo "Certificate imported."
        else
            warn "No certificate imported. This might just be a standard key login."
        fi
        
        echo "opk" > "$TEMPLATE_PATH/.type"
        chmod 600 "$TEMPLATE_PATH/identity"
        
        echo "Template configured for OpenPubKey."
        log_event "template-opk" "$TEMPLATE_NAME" "Generated OPK identity (Issuer: ${ISSUER:-default})"
        ;;
    edit-config)
        if [ ! -d "$TEMPLATE_PATH" ]; then err "Template not found."; fi
        ${EDITOR:-nano} "$TEMPLATE_PATH/config"
        log_event "template-edit" "$TEMPLATE_NAME" "Edited config"
        ;;
    remove)
        if [ ! -d "$TEMPLATE_PATH" ]; then err "Template not found."; fi
        read -p "Delete template '$TEMPLATE_NAME'? (y/N) " c
        if [[ "$c" == "y" || "$c" == "Y" ]]; then 
            rm -rf "$TEMPLATE_PATH"
            echo "Deleted."
            log_event "template-delete" "$TEMPLATE_NAME" "Deleted template"
        fi
        ;;
    *) usage ;;
esac
