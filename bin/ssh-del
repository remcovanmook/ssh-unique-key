#!/bin/bash
set -e

SCRIPT_DIR=$(dirname "$0")
# shellcheck source=./_ssh-unique-key.inc.sh
source "${SCRIPT_DIR}/_ssh-unique-key.inc.sh"

[ "$#" -ne 1 ] && err "Usage: ssh-del <hostname>"
HOST_NAME="$1"

CONFIG_SNIPPET_FILE="$CONFIG_DIR/$HOST_NAME"
[ ! -f "$CONFIG_SNIPPET_FILE" ] && err "No config found for '$HOST_NAME'."

# Get path and UUID *from the snippet* before deleting it
CANONICAL_PATH=$(get_uuid_path_from_host "$HOST_NAME")
[ -z "$CANONICAL_PATH" ] && exit 1
HOST_UUID=$(basename "$CANONICAL_PATH")

# 1. Remove the config snippet
rm "$CONFIG_SNIPPET_FILE"
echo "Removed config: $HOST_NAME"

# 2. Check for other snippets using this UUID
OTHER_ALIASES=$(grep -l "UUID: $HOST_UUID" "$CONFIG_DIR"/* 2>/dev/null || true)

if [ -z "$OTHER_ALIASES" ]; then
    echo "This was the last config for host $HOST_UUID."
    read -p "Delete all keys, configs, and 'by-key' link? (y/N) " confirm
    
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        rm "$KEY_DIR/$HOST_UUID"
        rm -rf "$CANONICAL_PATH"
        echo "Successfully deleted all data for $HOST_UUID."
    else
        echo "Aborted. Host identity $CANONICAL_PATH remains."
    fi
else
    echo "Other host configs still point to this identity:"
    echo "$OTHER_ALIASES" | xargs -n 1 basename
    echo "Identity $CANONICAL_PATH was not removed."
fi