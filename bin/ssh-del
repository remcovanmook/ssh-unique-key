#!/bin/bash
set -e
SCRIPT_DIR=$(dirname "$0")
# shellcheck source=./_ssh-unique-key.inc.sh
source "${SCRIPT_DIR}/_ssh-unique-key.inc.sh"

usage() {
    echo "Usage: ssh-del [user@]hostname"
    echo "  -V, --verbose       Enable verbose output"
    echo "  -h, --help          Show this help message"
    echo "  -v, --version       Show version information"
    exit 0
}

POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -v|--version) show_version ;;
        -V|--verbose) VERBOSE=1; shift ;;
        -*) err "Unknown option $1"; usage ;;
        *) POSITIONAL_ARGS+=("$1"); shift ;;
    esac
done
set -- "${POSITIONAL_ARGS[@]}"

if [ "$#" -ne 1 ]; then usage; fi

USER_HOST_ARG="$1"
HOST_NAME=$(get_host_from_arg "$USER_HOST_ARG")
USER_NAME=$(get_user_from_arg "$USER_HOST_ARG")

echo "Scanning $HOST_NAME..."
RAW_SCAN=$(get_full_host_scan "$HOST_NAME" 2>/dev/null)

if [ -z "$RAW_SCAN" ]; then
    HOST_SYMLINK="$HOST_DIR/$HOST_NAME"
    if [ -L "$HOST_SYMLINK" ]; then
        CANONICAL=$(readlink -f "$HOST_SYMLINK")
        UUID=$(basename "$CANONICAL")
    else
        err "Host unreachable and no symlink found."
    fi
else
    SCAN_SORTED=$(echo "$RAW_SCAN" | sort)
    UUID=$(get_host_uuid_from_scan_data "$SCAN_SORTED")
    CANONICAL="$UUID_DIR/$UUID"
fi

if [ ! -d "$CANONICAL" ]; then
    err "No identity found."
fi

USER_KEY_DIR="$CANONICAL/$USER_NAME"
if [ ! -d "$USER_KEY_DIR" ]; then
    err "No keys for '$USER_NAME'."
fi

read -p "Delete keys for $USER_NAME@$HOST_NAME? (y/N) " c
if [[ "$c" != "y" && "$c" != "Y" ]]; then exit 0; fi

rm -rf "$USER_KEY_DIR"
echo "Removed keys for user."
log_event "delete-user" "$USER_HOST_ARG" "Removed keys for user"

OTHER_USERS=$(find "$CANONICAL" -mindepth 1 -maxdepth 1 -type d)
if [ -n "$OTHER_USERS" ]; then
    echo "Other users exist. Host identity preserved."
    exit 0
fi

echo "Last user removed. Cleaning host..."
if [ -L "$HOST_DIR/$HOST_NAME" ]; then
    rm "$HOST_DIR/$HOST_NAME"
fi

STORED_KEYS="$CANONICAL/known_host_keys"
if [ -f "$STORED_KEYS" ]; then
    cat "$STORED_KEYS" | while read -r l; do
        B64=$(echo "$l" | awk '{print $3}')
        if [ -n "$B64" ]; then rm -f "$KEY_DIR/$B64"; fi
    done
fi

# Check for any other aliases
ALIASES=$(find "$HOST_DIR" -type l -lname "*/$UUID")
if [ -z "$ALIASES" ]; then
    read -p "Delete full host identity? (y/N) " c
    if [[ "$c" == "y" || "$c" == "Y" ]]; then
        rm -rf "$CANONICAL"
        echo "Deleted."
        log_event "delete-host" "$HOST_NAME" "UUID: $UUID"
    fi
else
    echo "Aliases remain: $(echo "$ALIASES" | xargs -n1 basename)"
fi
