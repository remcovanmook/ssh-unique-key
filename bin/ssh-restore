#!/bin/bash
set -e
SCRIPT_DIR=$(dirname "$0")
# shellcheck source=./_ssh-unique-key.inc.sh
source "${SCRIPT_DIR}/_ssh-unique-key.inc.sh"

usage() {
    echo "Usage: ssh-restore -i input_file.tar.gz"
    echo "WARNING: This will overwrite existing keys in $BASE_DIR"
    echo "  -V, --verbose   Enable verbose output"
    echo "  -h, --help      Show this help message"
    echo "  -v, --version   Show version information"
    exit 0
}

INPUT_FILE=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -v|--version) show_version ;;
        -V|--verbose) VERBOSE=1; shift ;;
        -i) INPUT_FILE="$2"; shift 2 ;;
        *) usage ;;
    esac
done

if [ -z "$INPUT_FILE" ]; then usage; fi
if [ ! -f "$INPUT_FILE" ]; then err "Backup file not found."; fi

warn "This will overwrite configuration and keys in $BASE_DIR"
read -p "Are you sure? (y/N) " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then exit 1; fi

if [ -d "$BASE_DIR" ]; then
    SAFETY_BACKUP="${BASE_DIR}.pre-restore-$(date +%s)"
    echo "Moving current directory to $SAFETY_BACKUP..."
    mv "$BASE_DIR" "$SAFETY_BACKUP"
fi

mkdir -p "$BASE_DIR"
echo "Restoring from $INPUT_FILE..."

tar -xzf "$INPUT_FILE" -C "$(dirname "$BASE_DIR")"

chmod 700 "$BASE_DIR"
find "$BASE_DIR" -type d -exec chmod 700 {} \;
find "$BASE_DIR" -type f -name "id_*" -exec chmod 600 {} \;
find "$BASE_DIR" -type f -name "*.pub" -exec chmod 644 {} \;
find "$BASE_DIR" -type f -name "config" -exec chmod 600 {} \;

echo "Restore complete."
log_event "restore" "all" "Restored from $INPUT_FILE"
